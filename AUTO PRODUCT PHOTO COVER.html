<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starforge Image Processor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #2a2a2a;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: #333;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .drop-zone {
            border: 3px dashed #666;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #3a3a3a;
            margin-bottom: 30px;
        }

        .drop-zone:hover {
            border-color: #f0ead6;
            background: #404040;
        }

        .drop-zone.dragging {
            border-color: #f0ead6;
            background: #454545;
        }

        .drop-zone h2 {
            color: #f0ead6;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .drop-zone p {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 14px 28px;
            background: #f0ead6;
            color: #1a1a1a;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .action-buttons button:hover:not(:disabled) {
            background: #fff;
        }

        .action-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons button.primary {
            background: #d97706;
            color: white;
        }

        .action-buttons button.primary:hover:not(:disabled) {
            background: #ea8c16;
        }

        .action-buttons button.secondary {
            background: #4b5563;
            color: #f0ead6;
        }

        .action-buttons button.secondary:hover:not(:disabled) {
            background: #5b6573;
        }

        .pending-images {
            display: none;
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
        }

        .pending-images.active {
            display: block;
        }

        .pending-images h3 {
            color: #f0ead6;
            margin-bottom: 15px;
        }

        .pending-list {
            color: #999;
            line-height: 1.6;
        }

        .canvas-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            position: relative;
        }

        canvas {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-group input {
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #f0ead6;
            width: 180px;
        }

        .control-group input.wide {
            width: 400px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .gallery-item {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
        }

        .gallery-item img {
            width: 100%;
            height: auto;
            display: block;
        }

        .gallery-item-controls {
            padding: 12px;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .gallery-item-controls button {
            width: 100%;
            padding: 10px;
            background: #d97706;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .gallery-item-controls button:hover {
            background: #ea8c16;
        }

        .gallery-item-controls .filename {
            color: #999;
            font-size: 11px;
            text-align: center;
            word-break: break-all;
            margin-bottom: 4px;
        }

        .processing-indicator {
            display: none;
            color: #f0ead6;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
        }

        .processing-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="drop-zone" id="dropZone">
            <h2>Drop Images Here</h2>
            <p>or click to select JPG/PNG files</p>
            <input type="file" id="fileInput" multiple accept="image/jpeg,image/jpg,image/png">
        </div>

        <div class="pending-images" id="pendingImages">
            <h3>Pending Images</h3>
            <div class="pending-list" id="pendingList"></div>
        </div>

        <div class="action-buttons">
            <button id="processAllBtn" class="primary" disabled>Process All Images</button>
            <button id="downloadAllBtn" class="secondary" disabled>Download All</button>
            <button id="downloadZipBtn" class="secondary" disabled>Download as ZIP</button>
            <button id="clearAllBtn" disabled>Clear All</button>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Top Text</label>
                <input type="text" id="topText" value="STARFORGE">
            </div>
            <div class="control-group">
                <label>Bottom Text</label>
                <input type="text" id="bottomText" class="wide" value="Unlock All STARFORGE STL Files & Sell 3D Prints for Only $10">
            </div>
        </div>

        <div class="processing-indicator" id="processingIndicator">
            Processing images...
        </div>

        <div class="canvas-container">
            <canvas id="canvas" width="1080" height="1080" style="display:none;"></canvas>
        </div>

        <div class="gallery" id="gallery"></div>
    </div>

    <!-- JSZip library for ZIP functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const gallery = document.getElementById('gallery');
        const processingIndicator = document.getElementById('processingIndicator');
        const processAllBtn = document.getElementById('processAllBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const downloadZipBtn = document.getElementById('downloadZipBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const pendingImages = document.getElementById('pendingImages');
        const pendingList = document.getElementById('pendingList');

        let pendingFiles = [];
        let processedImages = [];

        // Preload Orbitron font
        async function loadFonts() {
            try {
                await document.fonts.load('bold 96px Orbitron');
                console.log('Orbitron font loaded');
            } catch (err) {
                console.log('Font loading error, retrying...', err);
                // Fallback: Try loading font differently
                const fontFace = new FontFace('Orbitron', 'url(https://fonts.gstatic.com/s/orbitron/v31/yMJMMIlzdpvBhQQL_SC3X9yhF25-T1nyGy6xpmIyXjU1pg.woff2)');
                await fontFace.load();
                document.fonts.add(fontFace);
            }
        }

        // Load fonts on page load
        loadFonts();

        // Drop zone events
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragging');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragging');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Process All button
        processAllBtn.addEventListener('click', async () => {
            if (pendingFiles.length === 0) return;

            // Ensure fonts are loaded before processing
            await loadFonts();

            processingIndicator.classList.add('active');
            processAllBtn.disabled = true;
            
            for (const file of pendingFiles) {
                await processImage(file);
            }
            
            pendingFiles = [];
            updatePendingDisplay();
            processingIndicator.classList.remove('active');
            downloadAllBtn.disabled = false;
            downloadZipBtn.disabled = false;
        });

        // Download All button with 2 second delay between downloads
        downloadAllBtn.addEventListener('click', () => {
            let downloadIndex = 0;
            
            function downloadNext() {
                if (downloadIndex < processedImages.length) {
                    const imageData = processedImages[downloadIndex];
                    downloadImage(imageData.dataUrl, imageData.filename);
                    downloadIndex++;
                    
                    // Show progress
                    downloadAllBtn.textContent = `Downloading ${downloadIndex}/${processedImages.length}...`;
                    
                    // Schedule next download after 2 seconds
                    setTimeout(downloadNext, 2000);
                } else {
                    // Reset button text when done
                    downloadAllBtn.textContent = 'Download All';
                }
            }
            
            downloadNext();
        });

        // Download ZIP button
        downloadZipBtn.addEventListener('click', async () => {
            if (processedImages.length === 0) return;
            
            downloadZipBtn.disabled = true;
            downloadZipBtn.textContent = 'Creating ZIP...';
            
            try {
                const zip = new JSZip();
                
                // Add each image to the ZIP
                for (const imageData of processedImages) {
                    // Convert data URL to blob
                    const base64Data = imageData.dataUrl.split(',')[1];
                    // Get filename without extension (handle multiple periods properly)
                    const lastDotIndex = imageData.filename.lastIndexOf('.');
                    const nameWithoutExt = lastDotIndex > -1 ? imageData.filename.substring(0, lastDotIndex) : imageData.filename;
                    // Replace apostrophes and periods with underscores
                    const cleanedName = nameWithoutExt.replace(/['\.]/g, '_');
                    const filename = `${cleanedName} StarForge Kits 3D Print STL File.jpg`;
                    
                    zip.file(filename, base64Data, {base64: true});
                }
                
                // Generate the ZIP file
                const blob = await zip.generateAsync({type: 'blob'});
                
                // Create download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `starforge_images_${new Date().getTime()}.zip`;
                link.click();
                
                // Clean up
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Error creating ZIP:', error);
                alert('Failed to create ZIP file. Please try downloading images individually.');
            } finally {
                downloadZipBtn.disabled = false;
                downloadZipBtn.textContent = 'Download as ZIP';
            }
        });

        // Clear All button
        clearAllBtn.addEventListener('click', () => {
            pendingFiles = [];
            processedImages = [];
            gallery.innerHTML = '';
            updatePendingDisplay();
            downloadAllBtn.disabled = true;
            downloadZipBtn.disabled = true;
            clearAllBtn.disabled = true;
        });

        function handleFiles(files) {
            const imageFiles = Array.from(files).filter(file => 
                file.type === 'image/jpeg' || file.type === 'image/jpg' || file.type === 'image/png'
            );

            if (imageFiles.length === 0) {
                alert('Please select valid image files (JPG or PNG)');
                return;
            }

            pendingFiles = pendingFiles.concat(imageFiles);
            updatePendingDisplay();
        }

        function updatePendingDisplay() {
            if (pendingFiles.length > 0) {
                pendingImages.classList.add('active');
                pendingList.innerHTML = `${pendingFiles.length} image(s) ready to process:<br>` + 
                    pendingFiles.map(f => `â€¢ ${f.name}`).join('<br>');
                processAllBtn.disabled = false;
            } else {
                pendingImages.classList.remove('active');
                pendingList.innerHTML = '';
                processAllBtn.disabled = true;
            }

            clearAllBtn.disabled = pendingFiles.length === 0 && processedImages.length === 0;
        }

        async function processImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        await createProcessedImage(img, file.name);
                        resolve();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function createProcessedImage(img, filename) {
            // Clear canvas with dark gray background
            ctx.fillStyle = '#2c2c2c';
            ctx.fillRect(0, 0, 1080, 1080);

            // Define layout dimensions
            const topBoxHeight = 180;
            const imageBoxSize = 740;
            const imageBoxBorderWidth = 10;
            const imageBoxRadius = 30;
            const bottomTextMargin = 20;
            
            // Calculate vertical positions
            // Image box should be centered between top box and bottom text
            const availableHeight = 1080 - topBoxHeight - 40; // 40 for bottom text area
            const imageBoxY = topBoxHeight + (availableHeight - imageBoxSize) / 2 - 10; // Shifted up by 10px
            const imageBoxX = (1080 - imageBoxSize) / 2;
            
            // Draw the image box with border and rounded corners
            ctx.save();
            
            // Create rounded rectangle path for clipping
            ctx.beginPath();
            ctx.moveTo(imageBoxX + imageBoxRadius, imageBoxY);
            ctx.lineTo(imageBoxX + imageBoxSize - imageBoxRadius, imageBoxY);
            ctx.quadraticCurveTo(imageBoxX + imageBoxSize, imageBoxY, imageBoxX + imageBoxSize, imageBoxY + imageBoxRadius);
            ctx.lineTo(imageBoxX + imageBoxSize, imageBoxY + imageBoxSize - imageBoxRadius);
            ctx.quadraticCurveTo(imageBoxX + imageBoxSize, imageBoxY + imageBoxSize, imageBoxX + imageBoxSize - imageBoxRadius, imageBoxY + imageBoxSize);
            ctx.lineTo(imageBoxX + imageBoxRadius, imageBoxY + imageBoxSize);
            ctx.quadraticCurveTo(imageBoxX, imageBoxY + imageBoxSize, imageBoxX, imageBoxY + imageBoxSize - imageBoxRadius);
            ctx.lineTo(imageBoxX, imageBoxY + imageBoxRadius);
            ctx.quadraticCurveTo(imageBoxX, imageBoxY, imageBoxX + imageBoxRadius, imageBoxY);
            ctx.closePath();
            
            // Clip to the rounded rectangle
            ctx.clip();
            
            // Calculate image scaling to COVER the box (fill entire area, crop if needed)
            const scale = Math.max(imageBoxSize / img.width, imageBoxSize / img.height);
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            
            // Center the image within the box (it may overflow and get cropped)
            const imageX = imageBoxX + (imageBoxSize - scaledWidth) / 2;
            const imageY = imageBoxY + (imageBoxSize - scaledHeight) / 2;
            
            // Draw the original image (fills entire clipped area)
            ctx.drawImage(img, imageX, imageY, scaledWidth, scaledHeight);
            
            ctx.restore();
            
            // Now draw the border on top (outside the clipped area)
            ctx.beginPath();
            ctx.moveTo(imageBoxX + imageBoxRadius, imageBoxY);
            ctx.lineTo(imageBoxX + imageBoxSize - imageBoxRadius, imageBoxY);
            ctx.quadraticCurveTo(imageBoxX + imageBoxSize, imageBoxY, imageBoxX + imageBoxSize, imageBoxY + imageBoxRadius);
            ctx.lineTo(imageBoxX + imageBoxSize, imageBoxY + imageBoxSize - imageBoxRadius);
            ctx.quadraticCurveTo(imageBoxX + imageBoxSize, imageBoxY + imageBoxSize, imageBoxX + imageBoxSize - imageBoxRadius, imageBoxY + imageBoxSize);
            ctx.lineTo(imageBoxX + imageBoxRadius, imageBoxY + imageBoxSize);
            ctx.quadraticCurveTo(imageBoxX, imageBoxY + imageBoxSize, imageBoxX, imageBoxY + imageBoxSize - imageBoxRadius);
            ctx.lineTo(imageBoxX, imageBoxY + imageBoxRadius);
            ctx.quadraticCurveTo(imageBoxX, imageBoxY, imageBoxX + imageBoxRadius, imageBoxY);
            ctx.closePath();
            
            // Draw border
            ctx.strokeStyle = '#d97706';
            ctx.lineWidth = imageBoxBorderWidth;
            ctx.stroke();
            
            ctx.restore();

            // Draw top box
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, 1080, topBoxHeight);
            
            // Draw horizontal line through the middle of top box
            ctx.fillStyle = '#4b5563';
            ctx.fillRect(0, (topBoxHeight / 2) - 4, 1080, 8);
            
            // Draw top box bottom line
            ctx.fillStyle = '#c4bfac';
            ctx.fillRect(0, topBoxHeight - 4, 1080, 4);
            
            // Measure text for background box
            ctx.font = 'bold 96px "Orbitron", sans-serif';
            const topText = document.getElementById('topText').value;
            const textMetrics = ctx.measureText(topText);
            const textWidth = textMetrics.width;
            
            // Draw background box behind STARFORGE text
            const boxPaddingX = 50;
            const boxPaddingY = 5;
            const boxX = 540 - (textWidth / 2) - boxPaddingX;
            const boxWidth = textWidth + (boxPaddingX * 2);
            const boxY = (topBoxHeight / 2) - 48 - boxPaddingY; // 48 is roughly half the font height
            const boxHeight = 96 + (boxPaddingY * 2);
            
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(boxX, boxY, boxWidth, boxHeight);
            
            // Draw top text (STARFORGE) - ensure font is loaded
            ctx.fillStyle = '#f0ead6';
            ctx.font = 'bold 96px "Orbitron", sans-serif';
            ctx.fontWeight = '700';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(topText, 540, topBoxHeight / 2);
            
            // Draw bottom text
            ctx.fillStyle = '#c4bfac';
            ctx.font = '35px "Inter", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            const bottomText = document.getElementById('bottomText').value;
            ctx.fillText(bottomText, 540, 1080 - bottomTextMargin);
            
            // Add to gallery - now using JPEG format
            const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
            addToGallery(dataUrl, filename);
            
            // Store for download all
            processedImages.push({
                dataUrl: dataUrl,
                filename: filename
            });
        }

        function addToGallery(dataUrl, originalFilename) {
            const galleryItem = document.createElement('div');
            galleryItem.className = 'gallery-item';
            
            const img = document.createElement('img');
            img.src = dataUrl;
            
            const controls = document.createElement('div');
            controls.className = 'gallery-item-controls';
            
            const filenameDiv = document.createElement('div');
            filenameDiv.className = 'filename';
            filenameDiv.textContent = originalFilename;
            
            const downloadBtn = document.createElement('button');
            downloadBtn.textContent = 'Download Image';
            downloadBtn.onclick = () => {
                downloadImage(dataUrl, originalFilename);
            };
            
            controls.appendChild(filenameDiv);
            controls.appendChild(downloadBtn);
            
            galleryItem.appendChild(img);
            galleryItem.appendChild(controls);
            
            gallery.appendChild(galleryItem);
            clearAllBtn.disabled = false;
        }

        function downloadImage(dataUrl, originalFilename) {
            const link = document.createElement('a');
            // Get filename without extension (handle multiple periods properly)
            const lastDotIndex = originalFilename.lastIndexOf('.');
            const nameWithoutExt = lastDotIndex > -1 ? originalFilename.substring(0, lastDotIndex) : originalFilename;
            // Replace apostrophes and periods with underscores
            const cleanedName = nameWithoutExt.replace(/['\.]/g, '_');
            link.download = `${cleanedName} StarForge Kits 3D Print STL File.jpg`;
            link.href = dataUrl;
            link.click();
        }
    </script>
</body>
</html>